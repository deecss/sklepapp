{% extends "admin_base.html" %}

{% block title %}Wystawione produkty{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* Modern UI Variables */
    :root {
        --primary-color: #4f46e5;
        --primary-hover: #4338ca;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --info-color: #3b82f6;
        --light-bg: #f9fafb;
        --border-color: #e5e7eb;
        --text-main: #1f2937;
        --text-secondary: #6b7280;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --radius-sm: 0.25rem;
        --radius-md: 0.375rem;
        --radius-lg: 0.5rem;
        --transition-fast: 0.15s ease;
        --transition-normal: 0.3s ease;
    }
    
    /* Animacje i efekty */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.2); }
        70% { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); }
        100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        20%, 60% { transform: translateX(-2px); }
        40%, 80% { transform: translateX(2px); }
    }
    
    /* Enhanced toast notification animations */
    @keyframes slideInUp {
        from {
            transform: translateY(50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutDown {
        from {
            transform: translateY(0);
            opacity: 1;
        }
        to {
            transform: translateY(50px);
            opacity: 0;
        }
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(255, 255, 255, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(255, 255, 255, 0);
        }
    }
    
    .toast-notification.show {
        animation: slideInUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }
    
    .toast-notification.hide {
        animation: slideOutDown 0.3s forwards;
    }
    
    .toast-icon {
        animation: pulse 2s infinite;
    }
    
    .product-row {
        transition: all var(--transition-normal);
        animation: fadeIn 0.3s ease-in-out;
        border-left: 3px solid transparent;
    }
    
    .product-row:hover {
        background-color: rgba(249, 250, 251, 0.8);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        border-left: 3px solid var(--primary-color);
    }
    
    .product-row.unsaved-changes {
        background-color: rgba(255, 249, 219, 0.7) !important;
        border-left: 3px solid var(--warning-color) !important;
    }
    
    .btn-icon {
        transition: all var(--transition-fast);
    }
    
    .btn-icon:hover {
        transform: scale(1.15);
    }
    
    .table-header {
        position: sticky;
        top: 0;
        background-color: var(--light-bg);
        z-index: 10;
        box-shadow: var(--shadow-sm);
        /* height: 60px; */ /* Removed fixed height */
    }
    
    .table-header th {
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-secondary);
        padding-top: 1rem;
        padding-bottom: 1rem;
    }
    
    .action-button {
        transition: all var(--transition-fast);
        position: relative;
        overflow: hidden;
    }
    
    .action-button::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 5px;
        height: 5px;
        background: rgba(255, 255, 255, 0.5);
        opacity: 0;
        border-radius: 100%;
        transform: scale(1, 1) translate(-50%);
        transform-origin: 50% 50%;
    }
    
    .action-button:hover::after {
        animation: ripple 1s ease-out;
    }
    
    @keyframes ripple {
        0% {
            transform: scale(0, 0);
            opacity: 0.5;
        }
        100% {
            transform: scale(20, 20);
            opacity: 0;
        }
    }
    
    .badge {
        padding: 0.2rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
    }
    
    .badge-green {
        background-color: rgba(16, 185, 129, 0.1);
        color: rgba(16, 185, 129, 1);
    }
    
    .badge-yellow {
        background-color: rgba(245, 158, 11, 0.1);
        color: rgba(245, 158, 11, 1);
    }
    
    .badge-red {
        background-color: rgba(239, 68, 68, 0.1);
        color: rgba(239, 68, 68, 1);
    }
    
    /* Form controls styling */
    input, select {
        transition: all var(--transition-fast);
        box-shadow: var(--shadow-sm);
    }
    
    input:hover, select:hover {
        border-color: #a5b4fc;
    }
    
    input:focus, select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
    }
    
    /* Custom checkbox styling */
    .animated-checkbox {
        position: relative;
        width: 1.2rem;
        height: 1.2rem;
        border-radius: var(--radius-sm);
        appearance: none;
        border: 2px solid #d1d5db;
        background-color: #fff;
        transition: all 0.3s;
        cursor: pointer;
        vertical-align: middle;
    }
    
    .animated-checkbox:checked {
        border-color: var(--primary-color);
        background-color: var(--primary-color);
    }
    
    .animated-checkbox:checked::after {
        content: '';
        position: absolute;
        top: 0.2rem;
        left: 0.35rem;
        width: 0.25rem;
        height: 0.5rem;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
        animation: checkmark 0.2s ease-in-out;
    }
    
    @keyframes checkmark {
        0% { opacity: 0; transform: rotate(45deg) scale(0.8); }
        100% { opacity: 1; transform: rotate(45deg) scale(1); }
    }
    
    /* Button animations and styles */
    .btn-primary {
        background-color: var(--primary-color);
        color: white;
        transition: all var(--transition-fast);
    }
    
    .btn-primary:hover {
        background-color: var(--primary-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }
    
    .btn-success {
        background-color: var(--success-color);
        color: white;
    }
    
    .btn-success:hover {
        background-color: #0da271;
    }
    
    .btn-danger {
        background-color: var(--danger-color);
        color: white;
    }
    
    .btn-danger:hover {
        background-color: #dc2626;
    }
    
    .btn-warning {
        background-color: var(--warning-color);
        color: white;
    }
    
    .btn-warning:hover {
        background-color: #d97706;
    }
    
    /* Card and container styling */
    .card {
        background-color: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        transition: all var(--transition-normal);
    }
    
    .card:hover {
        box-shadow: var(--shadow-lg);
    }
    
    /* Table styling */
    .products-table {
        border-collapse: separate;
        border-spacing: 0;
        width: 100%;
        border-radius: var(--radius-lg);
        overflow: hidden;
    }
    
    .products-table th:first-child {
        border-top-left-radius: var(--radius-lg);
    }
    
    .products-table th:last-child {
        border-top-right-radius: var(--radius-lg);
    }
    
    .products-table th,
    .products-table td {
        padding: 0.75rem; /* Reduced padding for more compact cells */
        vertical-align: middle;
        border-bottom: 1px solid var(--border-color);
        text-align: left; /* Ensure text is aligned to the left */
    }

    .products-table th {
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-size: 0.75rem;
        white-space: nowrap;
        background-color: var(--light-bg); /* Ensure header has a background */
        position: sticky; /* Make header sticky */
        top: 0; /* Stick to the top */
        z-index: 10; /* Ensure header is above other content */
    }

    /* Specific column widths */
    .products-table th.col-checkbox,
    .products-table td.col-checkbox {
        width: 3rem; /* Checkbox column */
        min-width: 3rem;
        text-align: center;
    }
    .products-table th.col-product,
    .products-table td.col-product {
        width: 25%; /* Product column */
        min-width: 200px;
    }
    .products-table th.col-category,
    .products-table td.col-category {
        width: 12%; /* Category column */
        min-width: 120px;
    }
    .products-table th.col-markup,
    .products-table td.col-markup {
        width: 10%; /* Markup column */
        min-width: 100px;
    }
    .products-table th.col-price,
    .products-table td.col-price {
        width: 10%; /* Price column */
        min-width: 110px;
    }
    .products-table th.col-vat,
    .products-table td.col-vat {
        width: 8%;  /* VAT column */
        min-width: 80px;
    }
    .products-table th.col-shipping,
    .products-table td.col-shipping {
        width: 12%; /* Shipping column */
        min-width: 140px;
    }
    .products-table th.col-stock,
    .products-table td.col-stock {
        width: 8%;  /* Stock column */
        min-width: 80px;
        text-align: center;
    }
    .products-table th.col-actions,
    .products-table td.col-actions {
        width: 12%; /* Actions column */
        min-width: 150px;
        text-align: center;
    }

    .products-table tr:last-child td {
        border-bottom: none;
    }
    
    /* Unified Notification System */
    .toast-container {
        position: fixed;
        bottom: 1.5rem;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        z-index: 9999;
        width: 100%;
        max-width: 400px;
        pointer-events: none; /* Allow clicking through container */
    }
    
    .toast-notification {
        position: relative;
        padding: 1rem 1.25rem;
        color: white;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-lg);
        opacity: 0;
        transform: translateY(30px) scale(0.9);
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), 
                    opacity 0.3s ease;
        width: 100%;
        display: flex;
        align-items: center;
        border-left: 4px solid rgba(255,255,255,0.5);
        pointer-events: auto; /* Make the notification clickable */
        min-height: 60px;
        overflow: hidden;
    }
    
    .toast-notification:before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(to right, rgba(255,255,255,0.1), transparent);
        pointer-events: none;
    }
    
    .toast-notification.show {
        transform: translateY(0) scale(1);
        opacity: 1;
    }
    
    .toast-notification.success {
        background-color: var(--success-color);
        border-left-color: #059669;
    }
    
    .toast-notification.error {
        background-color: var(--danger-color);
        border-left-color: #b91c1c;
    }
    
    .toast-notification.warning {
        background-color: var(--warning-color);
        border-left-color: #b45309;
    }
    
    .toast-notification.info {
        background-color: var(--info-color);
        border-left-color: #1d4ed8;
    }
    
    .toast-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
    }
    
    .toast-icon {
        flex-shrink: 0;
        margin-right: 0.75rem;
    }
    
    .toast-message {
        flex-grow: 1;
        font-weight: 500;
    }
    
    .toast-close {
        flex-shrink: 0;
        margin-left: 0.75rem;
        opacity: 0.7;
        cursor: pointer;
        transition: opacity 0.2s;
    }
    
    .toast-close:hover {
        opacity: 1;
    }
    
    @keyframes progress {
        from { width: 100%; }
        to { width: 0%; }
    }
    
    .toast-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 3px;
        background-color: rgba(255,255,255,0.3);
        width: 100%;
        animation: progress 3s linear forwards;
    }
    
    /* Modal transitions */
    .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.5);
        transition: opacity 0.3s ease;
    }
    
    .modal-content {
        transition: all 0.3s ease;
    }
    
    /* Loader animations */
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .loading-spinner {
        width: 1.5rem;
        height: 1.5rem;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s linear infinite;
        display: inline-block;
    }
    
    /* Fix for table layout */
    .table-container {
        overflow-x: auto;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        background-color: white;
    }
    
    .products-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .products-table th,
    .products-table td {
        padding: 0.75rem; /* Reduced padding for more compact cells */
        vertical-align: middle;
        border-bottom: 1px solid var(--border-color);
        text-align: left; /* Ensure text is aligned to the left */
    }

    .products-table th {
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-size: 0.75rem;
        white-space: nowrap;
        background-color: var(--light-bg); /* Ensure header has a background */
        position: sticky; /* Make header sticky */
        top: 0; /* Stick to the top */
        z-index: 10; /* Ensure header is above other content */
    }

    /* Specific column widths */
    .products-table th.col-checkbox,
    .products-table td.col-checkbox {
        width: 3rem; /* Checkbox column */
        min-width: 3rem;
        text-align: center;
    }
    .products-table th.col-product,
    .products-table td.col-product {
        width: 25%; /* Product column */
        min-width: 200px;
    }
    .products-table th.col-category,
    .products-table td.col-category {
        width: 12%; /* Category column */
        min-width: 120px;
    }
    .products-table th.col-markup,
    .products-table td.col-markup {
        width: 10%; /* Markup column */
        min-width: 100px;
    }
    .products-table th.col-price,
    .products-table td.col-price {
        width: 10%; /* Price column */
        min-width: 110px;
    }
    .products-table th.col-vat,
    .products-table td.col-vat {
        width: 8%;  /* VAT column */
        min-width: 80px;
    }
    .products-table th.col-shipping,
    .products-table td.col-shipping {
        width: 12%; /* Shipping column */
        min-width: 140px;
    }
    .products-table th.col-stock,
    .products-table td.col-stock {
        width: 8%;  /* Stock column */
        min-width: 80px;
        text-align: center;
    }
    .products-table th.col-actions,
    .products-table td.col-actions {
        width: 12%; /* Actions column */
        min-width: 150px;
        text-align: center;
    }

    .products-table tr:last-child td {
        border-bottom: none;
    }
    
    /* Animation for save button */
    .animate-pulse {
        animation: pulse 2s infinite;
    }

    /* Additional stacked notification effect when multiple notifications appear */
    .toast-container .toast-notification:nth-child(n+2) {
        margin-top: -40px; /* Create an overlapping effect */
        z-index: calc(9999 - var(--index, 0)); /* Lower z-index for subsequent toasts */
    }

    .toast-container .toast-notification.show:nth-child(n+2) {
        margin-top: 0.75rem; /* When visible, stack them properly */
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), 
                   opacity 0.3s ease,
                   margin-top 0.3s ease 0.1s; /* Delay margin change until after animation */
    }
    
    /* Toast notification hover effect */
    .toast-notification:hover {
        transform: translateY(-3px) scale(1.02) !important;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
</style>
{% endblock %}

{% block admin_content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6 text-gray-800 flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
        </svg>
        Wystawione produkty
        <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
            {{ products|length }}
        </span>
    </h1>
    
    <!-- Filtry produktów -->
    <div class="card p-6 mb-6 transition-all duration-300 hover:shadow-lg">
        <div class="flex flex-wrap gap-4 items-end">
            <div class="flex-1 min-w-[250px]">
                <label for="searchQuery" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    Wyszukaj produkt
                </label>
                <input type="text" id="searchQuery" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-200" placeholder="Wpisz nazwę, ID, EAN...">
            </div>
            
            <div class="w-[200px]">
                <label for="categoryFilter" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                    </svg>
                    Kategoria
                </label>
                <select id="categoryFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-200">
                    <option value="">Wszystkie kategorie</option>
                    {% for category in categories %}
                    <option value="{{ category }}">{{ category }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="flex items-end">
                <button id="applyFilters" class="btn-primary py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                    </svg>
                    Filtruj
                </button>
            </div>
        </div>
    </div>
    
    <!-- Lista produktów -->
    <div class="card p-6 transition-all duration-300">
        <div class="flex justify-between items-center mb-6 flex-wrap gap-3">
            <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
                Produkty wystawione do sprzedaży 
                <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                    {{ products|length }}
                </span>
            </h2>
            <div class="flex flex-wrap gap-2">
                <button id="bulkPriceUpdate" class="btn-primary px-4 py-2 rounded-lg transition-all duration-200 flex items-center shadow-sm hover:shadow">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1 btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    Masowa edycja
                </button>
                <button id="toggleAllAvailability" class="btn-danger px-4 py-2 rounded-lg transition-all duration-200 flex items-center shadow-sm hover:shadow">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1 btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                    </svg>
                    Wycofaj wszystkie
                </button>
                <button id="updateAllPricesWithMarkup" class="btn-success px-4 py-2 rounded-lg transition-all duration-200 flex items-center shadow-sm hover:shadow">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1 btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Aktualizuj ceny
                </button>
                <button id="generateDescriptionsBulk" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-all duration-200 flex items-center shadow-sm hover:shadow">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1 btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                    Generuj opisy
                </button>
            </div>
        </div>
        
        {% if products %}
        <div class="table-container">
            <table class="products-table min-w-full divide-y divide-gray-200">
                <thead class="table-header">
                    <tr class="bg-gray-50">
                        <th scope="col" class="col-checkbox px-3 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider"> <!-- Removed text-left -->
                            <input type="checkbox" id="selectAll" class="animated-checkbox mx-auto">
                        </th>
                        <th scope="col" class="col-product px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"> <!-- Removed flex items-center -->
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                                </svg>
                                Produkt
                            </div>
                        </th>
                        <th scope="col" class="col-category px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"> <!-- Removed flex items-center -->
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                                </svg>
                                Kategoria
                            </div>
                        </th>
                        <th scope="col" class="col-markup px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"> <!-- Removed flex items-center -->
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Narzut
                            </div>
                        </th>
                        <th scope="col" class="col-price px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"> <!-- Removed flex items-center -->
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Cena
                            </div>
                        </th>
                        <th scope="col" class="col-vat px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"> <!-- Removed flex items-center -->
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2z" />
                                </svg>
                                VAT
                            </div>
                        </th>
                        <th scope="col" class="col-shipping px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"> <!-- Removed flex items-center -->
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                                </svg>
                                Wysyłka
                            </div>
                        </th>
                        <th scope="col" class="col-stock px-3 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider"> <!-- Removed flex items-center and text-left -->
                            <div class="flex items-center"> <!-- text-align: center from col-stock CSS will apply here -->
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                                </svg>
                                Stan
                            </div>
                        </th>
                        <th scope="col" class="col-actions px-3 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider"> <!-- Removed flex items-center justify-center and text-left -->
                            <div class="flex items-center justify-center"> <!-- text-align: center from col-actions CSS will apply here -->
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                                Akcje
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="productsTableBody">
                    {% for product in products %}
                    <tr class="product-row" data-id="{{ product.id }}" data-name="{{ product.name }}" data-category="{{ product.category }}">
                        <td class="col-checkbox px-3 py-4 whitespace-nowrap">
                            <input type="checkbox" class="product-checkbox animated-checkbox mx-auto" data-id="{{ product.id }}">
                        </td>
                        <td class="col-product px-3 py-4">
                            <div class="flex items-center">
                                {% if product.image %}
                                <div class="h-12 w-12 rounded-lg overflow-hidden shadow-sm flex-shrink-0 border border-gray-200 bg-white">
                                    <img src="{{ product.image }}" alt="{{ product.name }}" class="h-full w-full object-contain">
                                </div>
                                {% else %}
                                <div class="h-12 w-12 rounded-lg bg-gray-100 flex items-center justify-center flex-shrink-0 border border-gray-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4-16m2 16l4-16M6 9h14M4 15h14" />
                                    </svg>
                                </div>
                                {% endif %}
                                <div class="ml-3">
                                    <div class="font-medium text-gray-900 truncate max-w-[180px]">{{ product.name }}</div>
                                    <div class="text-xs text-gray-500 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                                        </svg>
                                        ID: {{ product.id }}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="col-category px-3 py-4">
                            <span class="text-sm text-gray-500 bg-gray-100 px-2 py-1 rounded-full truncate max-w-[130px] inline-block">{{ product.category }}</span>
                        </td>
                        <td class="col-markup px-3 py-4">
                            <div class="flex items-center">
                                <input type="number" class="w-20 px-2 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 product-markup transition-all duration-200" 
                                    data-id="{{ product.id }}" 
                                    value="{{ product.markup_percent|default(0) }}" 
                                    step="0.1" min="0">
                                <span class="ml-1 text-gray-700 font-semibold">%</span>
                                {% if product.xml_id %}
                                <button class="ml-2 text-blue-600 hover:text-blue-800 update-price-from-xml btn-icon" data-id="{{ product.id }}" title="Przelicz cenę z XML">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                        <td class="col-price px-3 py-4">
                            <div class="flex flex-col">
                                {% if product.original_price %}
                                <span class="text-sm text-gray-500 line-through flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <span class="original-price">{{ product.original_price|default(0) }}</span> zł
                                </span>
                                {% endif %}
                                <div class="flex items-center mt-1">
                                    <input type="number" class="w-20 px-2 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 product-price transition-all duration-200" 
                                        data-id="{{ product.id }}" 
                                        value="{{ product.price }}" 
                                        step="0.01" min="0">
                                    <span class="ml-1 text-gray-700 font-semibold">zł</span>
                                </div>
                                {% if product.markup_percent %}
                                <div class="text-xs text-green-600 mt-1 price-with-markup flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                                    </svg>
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        <td class="col-vat px-3 py-4">
                            <select class="w-20 px-2 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 product-vat transition-all duration-200" 
                                data-id="{{ product.id }}">
                                <option value="23" {% if product.vat == 23 %}selected{% endif %}>23%</option>
                                <option value="8" {% if product.vat == 8 %}selected{% endif %}>8%</option>
                                <option value="5" {% if product.vat == 5 %}selected{% endif %}>5%</option>
                                <option value="0" {% if product.vat == 0 %}selected{% endif %}>0%</option>
                            </select>
                        </td>
                        <td class="col-shipping px-3 py-4">
                            <div class="flex flex-col gap-2">
                                <select class="w-28 px-2 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 product-delivery-time transition-all duration-200" 
                                    data-id="{{ product.id }}">
                                    <option value="1-2 dni" {% if product.delivery_time == '1-2 dni' %}selected{% endif %}>1-2 dni</option>
                                    <option value="2-3 dni" {% if product.delivery_time == '2-3 dni' %}selected{% endif %}>2-3 dni</option>
                                    <option value="3-5 dni" {% if product.delivery_time == '3-5 dni' %}selected{% endif %}>3-5 dni</option>
                                    <option value="5-7 dni" {% if product.delivery_time == '5-7 dni' %}selected{% endif %}>5-7 dni</option>
                                    <option value="7-14 dni" {% if product.delivery_time == '7-14 dni' %}selected{% endif %}>7-14 dni</option>
                                    <option value="14-30 dni" {% if product.delivery_time == '14-30 dni' or not product.delivery_time %}selected{% endif %}>14-30 dni</option>
                                </select>
                                <div class="flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <input type="number" class="w-16 px-2 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 product-delivery-cost transition-all duration-200" 
                                        data-id="{{ product.id }}" 
                                        value="{{ product.delivery_cost|default(0) }}" 
                                        step="0.01" min="0">
                                    <span class="ml-1 text-xs text-gray-700 font-medium">zł</span>
                                </div>
                            </div>
                        </td>
                        <td class="col-stock px-3 py-4">
                            {% if product.stock > 10 %}
                            <span class="badge badge-green">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                                {{ product.stock }}
                            </span>
                            {% elif product.stock > 0 %}
                            <span class="badge badge-yellow">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                {{ product.stock }}
                            </span>
                            {% else %}
                            <span class="badge badge-red">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                                {{ product.stock }}
                            </span>
                            {% endif %}
                        </td>
                        <td class="col-actions px-3 py-4 text-sm font-medium">
                            <div class="flex flex-col space-y-2 items-center">
                                <button class="text-white bg-indigo-600 hover:bg-indigo-700 px-3 py-1 rounded-md flex items-center justify-center action-button transition-all duration-200 save-product-changes w-full max-w-[120px]" data-id="{{ product.id }}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                    </svg>
                                    Zapisz
                                </button>
                                <button class="text-white bg-red-600 hover:bg-red-700 px-3 py-1 rounded-md flex items-center justify-center action-button transition-all duration-200 toggle-availability w-full max-w-[120px]" data-id="{{ product.id }}" data-available="false">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                    Wycofaj
                                </button>
                                <button class="text-white bg-purple-600 hover:bg-purple-700 px-3 py-1 rounded-md flex items-center justify-center action-button transition-all duration-200 generate-description w-full max-w-[120px]" data-id="{{ product.id }}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                    </svg>
                                    Generuj opis
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-gray-500 text-center py-8 bg-gray-50 rounded-lg flex flex-col items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
            </svg>
            <p class="text-lg font-medium">Brak wystawionych produktów.</p>
            <p class="text-sm text-gray-400">Wystaw produkty z zakładki "Produkty z XML"</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal do masowej aktualizacji cen -->
<div id="bulkUpdateModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden transition-opacity duration-300 ease-in-out modal-backdrop">
    <div class="bg-white rounded-lg shadow-2xl p-6 max-w-md w-full transform transition-all duration-300 scale-95 opacity-0 modal-content" id="modalContent">
    </div>
</div>

<!-- Test notification panel (Hidden by default, toggle with keyboard shortcut Ctrl+Shift+N) -->
<div id="testNotificationPanel" class="fixed bottom-4 right-4 bg-white rounded-lg shadow-xl p-4 z-40 hidden transition-all duration-300 transform scale-95 opacity-0">
    <div class="flex justify-between items-center mb-3">
        <h3 class="text-lg font-semibold text-gray-800">Test Notifications</h3>
        <button id="closeTestPanel" class="text-gray-500 hover:text-gray-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
    </div>
    <div class="grid grid-cols-2 gap-2">
        <button id="testSuccessNotification" class="bg-green-500 hover:bg-green-600 text-white py-2 px-3 rounded-md text-sm">Success</button>
        <button id="testErrorNotification" class="bg-red-500 hover:bg-red-600 text-white py-2 px-3 rounded-md text-sm">Error</button>
        <button id="testWarningNotification" class="bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-3 rounded-md text-sm">Warning</button>
        <button id="testInfoNotification" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-3 rounded-md text-sm">Info</button>
        <button id="testMultipleNotifications" class="bg-purple-500 hover:bg-purple-600 text-white py-2 px-3 rounded-md text-sm col-span-2">Test Multiple</button>
    </div>
</div>

<script>
// Initialize notification system 
function initNotificationSystem() {
    // Create the toast container once at initialization
    let container = document.querySelector('.toast-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container';
        document.body.appendChild(container);
    }
    
    // Add utility to manage multiple notifications
    window.notificationQueue = [];
    window.notificationActive = false;
    
    // Check if showToast is already defined to avoid duplicate definitions
    if (!window.originalShowToast) {
        // Store the original showToast function if it exists
        window.originalShowToast = window.showToast || function(message, type = 'success') {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            
            // Set appropriate icon based on notification type
            let icon = '';
            if (type === 'success') {
                icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>`;
            } else if (type === 'error') {
                icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>`;
            } else if (type === 'warning') {
                icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>`;
            } else {
                icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>`;
            }
            
            // Create content structure
            toast.innerHTML = `
                <div class="toast-content">
                    <span class="toast-icon">${icon}</span>
                    <span class="toast-message">${message}</span>
                    <span class="toast-close">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </span>
                </div>
                <div class="toast-progress"></div>
            `;
            
            // Add to container
            container.appendChild(toast);
            
            // Show with animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Add event listener to close button
            const closeBtn = toast.querySelector('.toast-close');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    closeToast(toast);
                });
            }
            
            // Automatically close after 5 seconds
            const toastTimeout = setTimeout(() => {
                closeToast(toast);
            }, 5000);
            
            // Store the timeout ID on the toast element
            toast.dataset.timeoutId = toastTimeout;
            
            // Pause the timeout on mouseenter
            toast.addEventListener('mouseenter', () => {
                clearTimeout(toast.dataset.timeoutId);
                // Pause progress animation
                const progressBar = toast.querySelector('.toast-progress');
                if (progressBar) {
                    progressBar.style.animationPlayState = 'paused';
                }
            });
            
            // Resume the timeout on mouseleave
            toast.addEventListener('mouseleave', () => {
                toast.dataset.timeoutId = setTimeout(() => {
                    closeToast(toast);
                }, 5000);
                // Resume progress animation
                const progressBar = toast.querySelector('.toast-progress');
                if (progressBar) {
                    progressBar.style.animationPlayState = 'running';
                }
            });
            
            return toast;
        };
    }
    
    // Override the showToast function to use the queue
    window.showToast = function(message, type = 'success') {
        // If we have more than 3 visible notifications, queue this one
        const visibleToasts = document.querySelectorAll('.toast-notification.show').length;
        
        if (visibleToasts >= 3) {
            window.notificationQueue.push({message, type});
            return;
        }
        
        // Otherwise show it immediately
        window.originalShowToast(message, type);
        
        // Process queue after this notification is shown
        setTimeout(processNotificationQueue, 500);
    };
    
    // Function to process the queue
    function processNotificationQueue() {
        if (window.notificationQueue && window.notificationQueue.length > 0 && document.querySelectorAll('.toast-notification.show').length < 3) {
            const next = window.notificationQueue.shift();
            window.originalShowToast(next.message, next.type);
            
            // Continue processing if there are more in queue
            setTimeout(processNotificationQueue, 500);
        }
    }
    
    // Helper function to close a toast
    function closeToast(toast) {
        if (!toast) return;
        
        // Clear the timeout
        if (toast.dataset.timeoutId) {
            clearTimeout(parseInt(toast.dataset.timeoutId));
        }
        
        // Hide the toast
        toast.classList.remove('show');
        toast.classList.add('hide');
        
        // Remove from DOM after animation completes
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
            
            // Process the queue after a toast is removed
            processNotificationQueue();
        }, 300);
    }
    
    // Set up the notification test panel
    setupNotificationTestPanel();
}

document.addEventListener('DOMContentLoaded', function() {
    // Toast notification system
    function showToast(message, type = 'success') {
        // Create container if it doesn't exist
        let container = document.querySelector('.toast-container');
        if (!container) {
            container = document.createElement('div');
            container.className = 'toast-container';
            document.body.appendChild(container);
        }
        
        // Create toast notification
        const toast = document.createElement('div');
        toast.className = `toast-notification ${type}`;
        
        // Set appropriate icon based on notification type
        let icon = '';
        if (type === 'success') {
            icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>`;
        } else if (type === 'error') {
            icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>`;
        } else if (type === 'warning') {
            icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>`;
        } else if (type === 'info') {
            icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>`;
        }
        
        // Create content structure
        toast.innerHTML = `
            <div class="toast-content">
                <span class="toast-icon">${icon}</span>
                <span class="toast-message">${message}</span>
                <span class="toast-close">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </span>
            </div>
            <div class="toast-progress"></div>
        `;
        
        // Add to container
        container.appendChild(toast);
        
        // Add event listener to close button
        const closeBtn = toast.querySelector('.toast-close');
        closeBtn.addEventListener('click', () => {
            closeToast(toast);
        });
        
        // Add the show class to trigger animation after a short delay
        setTimeout(() => toast.classList.add('show'), 10);
        
        // Automatically remove the toast after 3 seconds
        const toastTimeout = setTimeout(() => {
            closeToast(toast);
        }, 3000);
        
        // Store timeout reference on the toast element
        toast.toastTimeout = toastTimeout;
        
        // Pause timeout on hover and resume on mouseout
        toast.addEventListener('mouseenter', () => {
            clearTimeout(toast.toastTimeout);
            // Also pause progress bar animation
            toast.querySelector('.toast-progress').style.animationPlayState = 'paused';
        });
        
        toast.addEventListener('mouseleave', () => {
            toast.toastTimeout = setTimeout(() => closeToast(toast), 2000);
            // Resume progress bar animation
            toast.querySelector('.toast-progress').style.animationPlayState = 'running';
        });
        
        // Helper function to close a toast with animation
        function closeToast(toast) {
            if (!toast || !toast.parentNode) return;
            
            // Clear any existing timeout
            if (toast.toastTimeout) {
                clearTimeout(toast.toastTimeout);
            }
            
            // Add hide class for exit animation
            toast.classList.add('hide');
            toast.classList.remove('show');
            
            // Remove from DOM after animation completes
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
                // Process the queue after a toast is removed
                processNotificationQueue();
            }, 300);
        }
    }
    
    // Initialize the notification system when the DOM is loaded
    initNotificationSystem();
});
</script>
{% endblock %}
